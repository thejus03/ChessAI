import random
from const import *

class Zobrist:
    def __init__(self):
        self.zobrist_table = [ [ [random.getrandbits(64) for _ in range(COLS)] for _ in range(ROWS) ]  for _ in range(NUM_PIECES)]
        # self.zobrist_table = [[[11013369414601300854, 8770356840602637222, 1161486587148989878, 18246911740855915708, 4301244922739870431, 16263093211545886566, 5050659188683148647, 2851346028966549742], [7791595531759543185, 5603540521261297257, 648031144036745604, 2367524783858070225, 3049562381711039341, 2806576222353912872, 3446439245541446977, 9038880897490570208], [10398998928716056676, 1290918941863138447, 8691899260150750840, 10959802725520504969, 13263046483690945479, 1641766733650709350, 2338534705659139919, 1299695696150775569], [16368105293856187402, 15899236088339705016, 4584851928003219878, 10770807645169650866, 9929774741991372781, 9355247379822744880, 913189061510322035, 7340037981299158124], [8128642101370245325, 14139686173099014299, 5355692563916920210, 14188481487631110133, 15452100718493050868, 15971347546376480879, 4218776724542485758, 14917810796481626824], [16749195469589502160, 7260767708028152061, 946105195257675814, 3793510064632419631, 12856582502194021432, 17089119354918424818, 5302166594720084294, 9088742040586607867], [6396343684645472326, 16623055443651442764, 4982213851736655837, 14967761455581415672, 10426471833701799521, 13641821771754453009, 9231485322955795059, 4973121357488747087], [10187907499576025687, 4455453663264279211, 11413280929714172435, 3894661606285396211, 10697985683739007770, 9187512036672633509, 17525157535227131385, 11642931452743359162]], [[16363487378753678628, 985403674126238320, 12544159645606945738, 13801122078731005538, 12264191101131665694, 9863232421644020672, 16977942165140458286, 11739016808293969003], [10439149639499951368, 6046356184786946309, 7582252309841816782, 9602363096459205031, 11460010325452925407, 8242466349267014423, 13711225208530041273, 15626964667419453675], [4030401222504524721, 7182556054067687722, 9003100726958998151, 2720897023351492091, 16524018244439398330, 1867933706279651903, 12408792262102449973, 9604065404694504932], [12387672968132750009, 9892276802413126096, 17495829885558589198, 2852704404751581639, 11419636585351203040, 8328603462803063379, 15734400855362501599, 6679406980488503634], [12094165774393896075, 888825350495868476, 9020899982191694448, 12539130391442109076, 53533798709935640, 15373530419421280978, 9767594768345436449, 8206303311790941734], [6093629041783013537, 14646661508606361996, 2045278706331593582, 2460001903281940333, 13371505280910122943, 274650558419625296, 15136140583218138918, 4749066918442125673], [5701475478187722453, 9473985119726761590, 17886412780461930485, 17536800348312650297, 17888125655624803887, 5421450587203098930, 17693032239057700229, 10602355660308809055], [18143174210968730549, 3568990302246228641, 4410856285780023526, 2854841591785630857, 8434228750297341856, 2381721610075470508, 7903769823563483734, 10913017984318053048]], [[6391830700844486412, 17179916108127555816, 10249625836617959252, 15230683114808273406, 17127674060076978908, 17625260158205572980, 4773849412145266067, 17554859217867583293], [11938140957813505698, 7204260712698479178, 14829494257889084317, 2942131272859748031, 664515516710268381, 7851732398989174083, 8763651572867476445, 5630924652836827481], [4938588312855820412, 14969213314163176768, 6979955820362583506, 6975457421372013278, 13664240721484521024, 11497394514344682977, 8230966463481857514, 10359516070322150004], [10265900028974076585, 10531162469161007839, 758158938396640442, 873053290576176297, 14011931617459120820, 428066915121886404, 1830119530204405586, 269821698633088681], [1781858538451260261, 11081893559006161890, 1417627281727024590, 16335461438888409267, 10659400270336070246, 1339065808771455602, 5353803199439727729, 2712165091702514940], [3952664049389076843, 16151973387501715869, 1448802842161200690, 3941223532259892547, 16507488129523539433, 13330048840916291300, 1524022701442754209, 4359642771850572677], [4296890817658957882, 5825903745201251968, 7102383481084257475, 7798222900425824342, 7064835151594524689, 5766484467313217481, 6273340184723781811, 13821745375941538559], [3584330132119674445, 13871748471460272377, 8264560051070608478, 8600082502318978382, 11018868836208825439, 12975204721735573455, 1042159643159763896, 17296769490274105827]], [[3447904867540611138, 2622227923522500126, 4744459891290914245, 13274885735757759144, 3568001344385530185, 16890370443102816104, 9295844402775109359, 17922926561795892701], [12126901097259239905, 15581524627949184898, 1782405159488744212, 4809861590851932766, 7837024479518204152, 210440019698145375, 5409097856861407079, 12242502517986639101], [16750141854169753091, 2181736650517965800, 15820474866911560624, 722368805128409902, 2021708143917864895, 2863196444353181070, 7536006909784526552, 2952463168923749143], [16295092167445879217, 2252780863865846348, 14965706893210203160, 14118511154134904053, 4022200985767095811, 537585776166630223, 15359201876495951624, 14140077406832660199], [6354136045752560323, 13487780673422969953, 5294861842010149305, 12354998540246048589, 3139127274688403053, 8637843275244777655, 8094927933865894144, 3817868941864244991], [9094861499471286987, 15724595166469043473, 13414152401972501287, 2120072716275792067, 4783307651245052585, 6860694872598798399, 1645438286941167123, 4595642873866347679], [11756772726823401049, 8237540424744016094, 6278387334161975738, 3946988123616960394, 12770366946708172373, 12145435945619450960, 14429451190003959565, 8202398426618004250], [4061984541740145678, 7787793019840719171, 13377674834920793273, 16555621777095759399, 6278258117613262403, 17345222888970364222, 17263272571226005323, 15684012803475146062]], [[14536410630001537590, 11197039972187981556, 17936666115609205367, 8339598371372923490, 17509594194984691309, 9754501158885077671, 1878826826660766844, 12214438722242611542], [11618599862403607977, 17978831363368354232, 14694976458427987792, 587268862069800370, 11961651793036124457, 5024943849142448945, 3310135105720651799, 15336858517916302901], [3305020127069668736, 18000868217105870609, 10158073586993040703, 17035624297075567804, 16666632444030664958, 2154500765447561174, 3165960568924180402, 12123661865186331463], [13622023929408997295, 4082751975582278782, 12801155540818185823, 268334429461922174, 11628534263847250263, 18402811444768082618, 15308731113258666796, 2678712616060995536], [10261509074899189896, 10823976404143133001, 3060599975939219010, 13502080615099779096, 2057184917958265080, 8123531132668145786, 194604934229111442, 14034358684834776154], [14332900100586136974, 9229286282158451634, 15397259242099230636, 8608736254580001023, 6068922561927295740, 4454679648790559162, 7525819133429328404, 4584180644946732218], [14995101327411186134, 8827581348931750599, 8726301982495686805, 11264059474535469431, 10609084548388265226, 17281517916615272526, 8243610944134455936, 382817008810239166], [14486901754919496332, 7530229979244541978, 10070857066771516934, 9940110360373723430, 11009740701726767490, 6802961973695042575, 17463316237893539993, 2337562926855624975]], [[2391932667013364685, 9615599339416346121, 17163041665517661990, 1147535706049950075, 18390034670440643638, 16292634460969664973, 18040471655356572791, 4944651243469476758], [3827056526109238222, 3547528522730576923, 13527181529033527447, 4957880096526749389, 16870598560434405630, 13226008664768525590, 12163399869519992129, 13194484531006361435], [8896785112319452457, 6839823809185416870, 16438811870042366581, 7063180771589133161, 14023165531847610359, 3423206674914881901, 7197584311319978848, 8744380670166260141], [1347419346479830904, 6340563791274060689, 14856439914428768970, 14032414317946570091, 17533648887967856565, 5617359814144360348, 10512209210329187812, 9291895515897489337], [5488651270436127748, 11987163191051984642, 2262814319761500849, 9396580767368221096, 14828952494992592278, 7781217935776102176, 16004118911683120679, 12453470056571727460], [235856864116310776, 18175884314853259189, 9379621797304017312, 1103988944427667124, 4985458531537896598, 12596416852475668725, 1580094286156100735, 14917918517089903368], [16941423472145805799, 17172254369410559883, 17650014211995058230, 13629442226381244120, 6015237659422916803, 1360221525190543720, 4006854654302624540, 3675744492499232166], [14317482102982239797, 13635791305001526554, 7296187429541966079, 9044504506963461380, 2441776837227213451, 14571420026296895346, 16027804039622585852, 16145564814792577927]], [[1342768529532720516, 12001895498309242024, 17702754262363353969, 15061125062271202403, 5478953701701122239, 3218362816258671794, 15775375577076034461, 1774330428928295601], [1035577623359912241, 13514030876897171353, 17553621374602516686, 16925857501711780477, 8687237931063270326, 15737524740575183289, 5624859316449043684, 3050185391739349521], [9044851236689778880, 16398784039187388201, 7463935734999160028, 10726908437244295502, 10331979528674122716, 14880986759909646739, 15855813581818917363, 13787857928388386007], [4599386586017575678, 2752457548952357110, 11454289236538467884, 13231242858720636434, 4871962721451849360, 13128476760263034968, 11843082076475905741, 954285648377613187], [10332412921746704400, 16500446562143154302, 2348130865297545128, 17700150297918453719, 8897581612461249142, 3393725949109977086, 3856191254252896984, 5519967494480604900], [1551709651145119389, 18361756328056810709, 13780653661156400710, 14007514546166425745, 16131979818961595684, 3767301410715978702, 4516457107189380165, 11287273068954105403], [10588773010034076685, 16878798574487716722, 10292912783105256398, 14903450083667328599, 14073864243114813001, 11829576915085593876, 500691354857385242, 11103610856731638071], [2433763909317802293, 10486205981468129936, 5489508897247410280, 7961299017157378649, 12219004080967822041, 4877056873495367134, 13817865364073382374, 11750947286839672692]], [[7286056523430673066, 14015761075028853563, 13360957373129118052, 12846278233919698914, 15444688948487896448, 17015295146361609018, 2103371435447890150, 14784410656807094966], [2959269290947081334, 10555749786306838709, 4640150311868821442, 3906737207382149046, 1949308236721978234, 210363663594063063, 15733427560222948085, 9640341267827037522], [1399531527458985980, 10046844208784634154, 14421240814745749516, 7082116899549485579, 17533283780097974786, 13355612580438957427, 17454282753495593587, 13248036598411514027], [6016860703328381824, 2545828996085232155, 12849764020136297537, 9054980525088265416, 5767865052321811552, 7573619876714115879, 2531972164688865875, 1895168741589102258], [7046835004199786055, 11196946281326614437, 598142570147278412, 4925197947668780722, 16566714120353336775, 5826761944494134616, 12435081561135708509, 2017767329581345249], [12230106617185922137, 15053742870990033391, 8554175195394974543, 18218867839880585200, 16560729557219486494, 2747225474499982235, 7735943754422248186, 8667787223348600701], [11611911330473201371, 17279224151633103224, 8765943668447040350, 10430980984934984985, 11073182789193844116, 8412133742115662840, 12435977368280216583, 8176535529697719657], [6322270139281448873, 10982554092062827005, 9554971943065722608, 7587434828272995945, 1523997771551019494, 12643281558537449413, 8747796282506054161, 939859848676421702]], [[13427321028777400960, 1022817307198023945, 18051981573930881085, 15806470309117845808, 13985293108230800543, 501434124196557365, 5210720401872954963, 756033860300594566], [17494539391831338772, 5141691444245745583, 17159600071449985437, 2347570559031203145, 6145536078874089838, 12913049557054835577, 2938860710506460124, 10283080394911677647], [5162045772856843167, 15685896921508373387, 18078767979666830687, 12700763165159567260, 8203072586824718958, 6921895781320065062, 3668278930804591889, 3896699631151073785], [2556683347264620432, 12905491259413559, 15417381123742785916, 5136267457951791159, 5418216928397572303, 6909214405467431945, 13519190009905686026, 6909831488556177325], [8569919025848951778, 4315379877727857896, 3226696594826240683, 6850169516911946782, 14381810721786941039, 4279175785455648770, 7121122782946429206, 11906932513081472929], [17724685427055324848, 2954640098678844911, 4398702860991229639, 15665386056839818439, 4172230229973882635, 10537688454275667494, 4392893597765856668, 2610290011242502457], [1308851761609576576, 10200719947301236277, 4270139723416677095, 16515169908380604738, 6565772976492678941, 5684221170538346494, 1151739848183219893, 17637040515032880862], [12482984892579678679, 13610863436240519251, 10574201677659526724, 9160315070435081488, 5611197754418927277, 249572377004399461, 8471838088241394206, 3602476432932551653]], [[5519876789702830129, 506535620455628726, 18384270422850287069, 12360988699361097714, 16361639083680074770, 9333429570472474639, 1877667082151535732, 190848827050030699], [17873245005166312180, 116913644944976681, 516083726029475203, 7403136183423187095, 1055655301023707005, 14515142092085279895, 9556191832265233606, 2151626225849583480], [3436781492424306122, 16310176819400210116, 10265477077238768675, 11673220354895825842, 6936256577834876178, 13288787955083912091, 6292573272183456902, 2147542815584683334], [8248706224478103447, 5168549710339555011, 18317346719805129432, 13186064120070738629, 15016126722598274098, 7609043094077294186, 8180812898797145882, 3273723389067993135], [3679387839815455244, 624601865294338321, 2678967713707379937, 1823390421197220639, 17848018563652963911, 18027674692697226463, 12301888851016914341, 6474231743532204094], [16811269944177042316, 5114147994322934482, 17165603724840577742, 12893907198659375059, 16199362895034861448, 6539398013279759937, 3593139514580656801, 14636945871302466435], [10192995251939089873, 3377933594900539405, 18106889031569726178, 7461840258463868127, 16289362905105797466, 7319482947174353524, 5617567476384068947, 2924371965150385387], [4271213477961190735, 1338559664324020164, 14328929626371110069, 1937975570849316015, 1773250718957266930, 14736440007581594239, 14096876158446975192, 15700512081244828073]], [[877519280797643233, 4765110533008833743, 11620955556124282686, 2085268807442916724, 3763537374412581693, 10738214999232777091, 6670011577637984586, 9552765184217859457], [8399204035817086747, 17270869804031928559, 7476459914218344155, 15699364483124704910, 17753249516619334210, 14561391416107468129, 10101544161577124004, 6426719279050135355], [12591436582946844071, 10296656038000612066, 9725542456554037125, 2457548041219941807, 1077501326054236178, 4005382253666859121, 13244974788263533601, 14215309150286811240], [892254413680495109, 17506526493747944779, 18286493252629897818, 1973085751449766746, 7575386068986292035, 17758076087316955134, 12278706379087376611, 10066049089803807824], [1590723933188806197, 12758737048397488526, 18261822359508043435, 9081298498260666995, 15757379646615324816, 9445258107785031923, 1568758747961397591, 11570298685009043325], [4511309617835871829, 9766205084417705263, 10920493583271482566, 3694880362024300364, 17486202614488220680, 8840098662879653610, 17514404299494218197, 10836748964026464031], [8861741607180007614, 12476225639186021384, 16736009980318387081, 2281346856267764074, 6220149842568335429, 2505130096210168790, 4772460712343072710, 17934995634261783697], [16012090489948918926, 16197937567915781636, 8454683483815810571, 13436068930069675005, 17360921779666741655, 16091387758232155833, 17523844563945063644, 16488463286192567280]], [[3378855741750484289, 12114942330564631733, 16267258608587783515, 14550945602484265910, 14348220536207626247, 5921448295315519179, 12334912112343676015, 17946347700717800164], [5407942359427435102, 16659291692505163472, 17540818864971270331, 13506365022257680645, 9214370987162296484, 12450645350493259133, 11346667763028991037, 7887112324375061637], [10219524278553725787, 4737266702671821378, 17568399786739027693, 4919242246754564629, 1548670723506232581, 14738666714734178320, 15086764983714000130, 7766554527869051769], [16801667746315391055, 961870596441298812, 3176548928630465808, 4527855536878828546, 1383523087832751189, 9291997691196991006, 3863152800204831010, 13046032508542861139], [9713410583747099388, 16304402649936912884, 2142031005660068134, 9348973930628946561, 3068963110447489810, 9916023059486172811, 16776997205649178604, 8048766583387927093], [12534700464046725146, 16246379106972019340, 6386858758643487612, 14194593688046733026, 734820411516164156, 10613187313055406442, 4397774260276820930, 5743801290142373622], [15296693226637840314, 4514738585023119403, 8815623789772198202, 5105223602873113952, 6537703020772838487, 11368910097522264981, 16596879993243606484, 17348123092429705121], [16791251636667014199, 1737325509733049513, 15834518294900524441, 15702976694385021066, 7755326761072294989, 7010712981591413873, 16840648650023127109, 9684340441036762015]]]

        self.zobrist_castling = [random.getrandbits(64) for _ in range(4)] # 2 for white, 2 for black
        # self.zobrist_castling = [277736896981579316, 6952739425955501075, 14796615813126261101, 8183380639127804551]
        
        # Indexes for specific pieces
        self.pieces = {
            "white": {
                "pawn": 0,
                "knight": 1,
                "bishop": 2,
                "rook": 3,
                "queen": 4,
                "king": 5
            },
            "black": {
                "pawn": 6,
                "knight": 7,
                "bishop": 8,
                "rook": 9,
                "queen": 10,
                "king": 11
            }
        }
        
        self.zobrist_en_passant = [ [random.getrandbits(64) for _ in range(COLS) ] for _ in range(ROWS)]
        # self.zobrist_en_passant = [[10518590555903415505, 7035058687516784562, 5682189472966863008, 6873314462006134864, 15472418743433144929, 5362292769368467288, 3135971518564507530, 2373419888420410052], [11153977201472761245, 197490606301736390, 4171718183262390649, 15818836151301918443, 12440022116490954222, 10809859271888812507, 18022818045380544517, 17548029705062480304], [15706982879623916591, 4662189772270701647, 13437906304857426153, 17417759214562277151, 12183675228298498773, 10265799775159474832, 1159515615076244067, 8141264637007146767], [3114678039380725949, 8463586339399870688, 11197896453175057658, 11823122329636462953, 3452856321412548955, 17994656334744427858, 680594968496063208, 13368019164940954390], [9868662387495368283, 5807161053441212793, 1723505052314969276, 7915744808735605030, 5145687957809360444, 16983173337578570745, 5507656615723748837, 5015696555498148121], [8691893436764677900, 16012634953808392762, 56079750485950777, 869309042570938394, 2527165742563287842, 10481726334227181043, 9580358041415692163, 5995460743414705436], [8549922028863027593, 8916042112151039611, 16127390482692760377, 16580108124406710153, 2073083917290021364, 2781369915778032357, 16163665847829102855, 5376490829737729916], [5070089484169197859, 14688275053171788562, 8089778207881876543, 7730240625065308344, 9486477824108402604, 10459058619362895230, 7764352381830250822, 7100617113056839872]]
        self.zobrist_turn = random.getrandbits(64) # For black's turn
        # self.zobrist_turn = 3622021829516308317
        # print(self.zobrist_table)
        # print()
        # print(self.zobrist_castling)
        # print()
        # print(self.zobrist_en_passant)
        # print()
        # print(self.zobrist_turn)
        
    def _piece_index(self, piece):
        return self.pieces[piece.color][piece.type]
    
    def get_hash(self, board, player):
        """
            Generates Hash value of board using the Zobrist Hashing algorithm
        """
        
        # print(board.white_pieces)
        # print(board.black_pieces)
        hash_value = 0
        for row, col in board.white_pieces:
            square = board.squares[row][col]
            piece = square.piece
            piece_index = self._piece_index(piece)
            hash_value ^= self.zobrist_table[piece_index][row][col]

            # En passant
            if piece.type == "pawn" and piece.en_passant:
                hash_value ^= self.zobrist_en_passant[row][col]     
            
            if piece.type == "king":
                rights = self._get_castling_rights(board, piece)
                
                if rights & 1: # White kingside
                    hash_value ^= self.zobrist_castling[0]
                if rights & 2: # White queenside
                    hash_value ^= self.zobrist_castling[1]
                # if rights & 4: # Black kingside
                #     hash_value ^= self.zobrist_castling[2]
                # if rights & 8: # Black queenside
                #     hash_value ^= self.zobrist_castling[3]
                    
        for row, col in board.black_pieces:
            square = board.squares[row][col]
            piece = square.piece
            piece_index = self._piece_index(piece)
            hash_value ^= self.zobrist_table[piece_index][row][col]

            # En passant
            if piece.type == "pawn" and piece.en_passant:
                hash_value ^= self.zobrist_en_passant[row][col]     
            
            if piece.type == "king":
                rights = self._get_castling_rights(board, piece)
                
                # if rights & 1: # White kingside
                #     hash_value ^= self.zobrist_castling[0]
                # if rights & 2: # White queenside
                #     hash_value ^= self.zobrist_castling[1]
                if rights & 4: # Black kingside
                    hash_value ^= self.zobrist_castling[2]
                if rights & 8: # Black queenside
                    hash_value ^= self.zobrist_castling[3]
                           
        # Player's turn
        if player == "black":
            hash_value ^= self.zobrist_turn
        
        return hash_value
    
    def _get_castling_rights(self, board, piece):
        """
            Returns castling rights of the board
        """
        rights = 0
        
        if board.can_castle(piece, "king"):
            if piece.color == "white":
                rights |= 1 
            else:
                rights |= 4
        
        if board.can_castle(piece, "queen"):
            if piece.color == "white":
                rights |= 2
            else:
                rights |= 8
        
        return rights